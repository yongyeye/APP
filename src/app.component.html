
<div class="min-h-screen max-w-md mx-auto shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden flex flex-col relative border-x border-[#3f4a36] bg-[#262a22]">
  
  <!-- PCB Texture Overlay for Whole App -->
  <div class="absolute inset-0 pointer-events-none z-0 opacity-10 bg-[radial-gradient(#3f4a36_1px,transparent_1px)] [background-size:8px_8px]"></div>

  <!-- Header Area -->
  <header class="pt-8 pb-4 px-6 sticky top-0 z-30 bg-[#262a22]/90 backdrop-blur border-b-2 border-[#5d6b4f]">
    
    <!-- Top Row: Title & Switch -->
    <div class="flex justify-between items-start mb-2">
      <div>
        <h1 class="text-2xl font-tech font-bold text-[#e2e8f0] tracking-widest uppercase flex items-center gap-2 group cursor-default">
          <span 
            class="w-3 h-3 rounded-full animate-pulse shadow-[0_0_8px_red]"
            [class.bg-red-500]="!activeSession()?.isSealed"
            [class.bg-green-500]="activeSession()?.isSealed"
            [class.shadow-green-500]="activeSession()?.isSealed"
          ></span>
          <span class="group-hover:text-green-400 transition-colors">PuzzleHabit</span>
        </h1>
      </div>
      
      <!-- View Toggle (Jumper Switch) -->
      <div class="flex flex-col gap-1 items-end">
         <span class="text-[8px] font-mono text-[#5d6b4f] uppercase tracking-widest">Mode Select</span>
         <div class="flex bg-[#1a1d16] p-1 rounded border border-[#5d6b4f]">
          <button 
            (click)="switchView('game')"
            class="px-3 py-1 text-[10px] font-tech uppercase tracking-widest transition-all rounded-sm"
            [class.bg-[#8e9684]]="currentView() === 'game'"
            [class.text-[#1a1d16]]="currentView() === 'game'"
            [class.text-[#5d6b4f]]="currentView() !== 'game'"
          >
            BOARD
          </button>
          <button 
            (click)="switchView('collection')"
            class="px-3 py-1 text-[10px] font-tech uppercase tracking-widest transition-all rounded-sm"
            [class.bg-[#8e9684]]="currentView() === 'collection'"
            [class.text-[#1a1d16]]="currentView() === 'collection'"
            [class.text-[#5d6b4f]]="currentView() !== 'collection'"
          >
            LOGS
          </button>
        </div>
      </div>
    </div>

    <!-- Second Row: System Stats (New Feature) -->
    <div class="flex items-center justify-between text-[10px] font-mono border-t border-[#3f4a36] pt-2 mt-2">
       <div class="flex items-center gap-3 text-[#8e9684]">
          <span class="flex items-center gap-1">
             <span class="opacity-50">KERNEL_VER:</span> 
             <span class="text-[#e2e8f0] font-bold">{{ systemVersion() }}</span>
          </span>
          <span class="w-[1px] h-3 bg-[#3f4a36]"></span>
          <span class="flex items-center gap-1">
             <span class="opacity-50">TOTAL_OPS:</span> 
             <span class="text-[#e2e8f0] font-bold">{{ totalOpsPerformed() }}</span>
          </span>
       </div>
       
       <!-- Active Session Date indicator -->
       <div class="text-[#5d6b4f]">
          @if (activeSession()) {
             DATE: {{ activeSession()?.dateStr }}
          } @else {
             OFFLINE
          }
       </div>
    </div>

  </header>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto p-6 hide-scrollbar relative z-10">
    
    @if (currentView() === 'game') {
      <!-- Puzzle Section (Main Processor) -->
      <section class="mb-12">
        <div class="flex justify-between items-center mb-2 border-b border-[#5d6b4f]/50 pb-1">
          <h2 class="text-xs font-tech font-bold text-[#8e9684] uppercase tracking-[0.2em] flex items-center gap-2">
            Processing Core 
            @if (activeSession()?.isSealed) {
              <span class="text-green-500 text-[8px] border border-green-500/50 px-1 rounded">[ARCHIVED]</span>
            }
          </h2>
          
          <!-- Only show Regenerate if NOT sealed -->
          @if (!activeSession()?.isSealed) {
            <button 
              (click)="regenerateCurrentPuzzle()"
              [disabled]="isGenerating()"
              class="text-[10px] text-[#5d6b4f] hover:text-[#e2e8f0] disabled:opacity-50 font-mono flex items-center gap-1"
            >
              <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
              RE-INIT IMG
            </button>
          }
        </div>
        
        <div class="relative">
          <app-puzzle-board 
            [imageUrl]="currentPuzzleImage()"
            [completedCount]="completedTasksCount()"
            [allTasksCompleted]="isAllTasksCompleted()"
            [readonly]="!!activeSession()?.isSealed"
            [gridSize]="activeSession()?.gridSize || 3"
            (puzzleCompleted)="sealSession()"
          ></app-puzzle-board>
          
          <!-- Loading Overlay -->
          @if (isGenerating()) {
            <div class="absolute inset-0 bg-[#1a1d16]/80 flex items-center justify-center backdrop-blur-sm z-50">
               <div class="flex flex-col items-center">
                 <div class="w-8 h-8 border-2 border-[#e2e8f0] border-t-transparent rounded-full animate-spin mb-2"></div>
                 <p class="text-xs font-tech text-[#e2e8f0] animate-pulse">GENERATING ASSETS...</p>
               </div>
            </div>
          }
        </div>
      </section>

      <!-- Task List Section (Memory Banks) -->
      <section>
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xs font-tech font-bold text-[#8e9684] uppercase tracking-[0.2em]">System Protocols</h2>
          
          <!-- Only show AI Suggest if NOT sealed -->
          @if (!activeSession()?.isSealed) {
            <button 
              (click)="suggestTasks()"
              [disabled]="isGenerating()"
              class="text-[10px] bg-[#3f4a36] text-[#e2e8f0] px-2 py-1 rounded border border-[#5d6b4f] hover:bg-[#4a5740] transition-colors"
            >
              AI SUGGEST
            </button>
          }
        </div>

        <app-task-list 
          [tasks]="currentTasks()"
          [readonly]="!!activeSession()?.isSealed"
          (toggle)="toggleTask($event)"
          (delete)="deleteTask($event)"
        ></app-task-list>

        <!-- Input Area - Hide if Sealed -->
        @if (!activeSession()?.isSealed) {
          <div class="mt-6 relative">
            <div class="flex items-center bg-[#1a1d16] border border-[#5d6b4f] rounded p-1 focus-within:ring-1 focus-within:ring-[#8e9684] focus-within:border-[#8e9684] transition-all">
              <div class="w-8 flex justify-center text-[#5d6b4f]">
                <span class="font-mono text-xs">></span>
              </div>
              <input 
                type="text" 
                [(ngModel)]="newTaskTitle" 
                (keydown.enter)="addTask()"
                placeholder="ENTER NEW PROTOCOL..." 
                class="bg-transparent border-none text-[#e2e8f0] font-mono text-sm w-full focus:outline-none placeholder-[#3f4a36]"
              />
              <button 
                (click)="addTask()"
                class="px-4 py-2 bg-[#e2e8f0] text-[#1a1d16] font-bold font-tech text-xs rounded-sm hover:bg-white transition-colors"
              >
                EXEC
              </button>
            </div>
          </div>
        } @else {
           <div class="mt-6 border-t border-dashed border-[#5d6b4f] py-4 text-center">
             <p class="text-[10px] font-mono text-[#5d6b4f] uppercase">This protocol log is read-only.</p>
           </div>
        }
      </section>
    } 
    
    @else {
      <!-- Collection View (Data Archive) -->
      <section class="animate-fade-in">
        <h2 class="text-xs font-tech font-bold text-[#8e9684] uppercase tracking-[0.2em] mb-6">Data Archives // Encrypted</h2>
        <app-puzzle-collection 
          [sessions]="sessions()"
          [activeId]="activeSessionId()"
          (sessionSelected)="selectSession($event)"
          (createSession)="onCreateNextDay()"
        ></app-puzzle-collection>
      </section>
    }

  </main>
</div>
